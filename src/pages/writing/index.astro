---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { formatDate } from '../../utils/formatDate';

// Get all published posts, sorted by date
const allPosts = await getCollection('posts', ({ data }) => data.published !== false);
const sortedPosts = allPosts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

// Helper to get post type
function getPostType(post: typeof allPosts[0]): 'poem' | 'newsletter' | 'research' | 'essay' {
  if (post.data.categories?.includes('Poems') || post.data.tags?.includes('poem')) {
    return 'poem';
  }
  if (post.data.tags?.includes('decibel') || post.data.categories?.includes('Newsletter')) {
    return 'newsletter';
  }
  if (post.data.tags?.includes('research')) {
    return 'research';
  }
  return 'essay';
}
---

<BaseLayout title="Writing | Alex Wilson" description="Essays on mental models, growth, and the things I'm trying to understand. Poems for the moments that ask for something else.">
  <section class="intro">
    <h1>Writing</h1>

    <p class="intro__text">
      Essays on mental models, growth, and the things I'm trying to understand.
      Poems for the moments that ask for something else.
    </p>
  </section>

  <div class="search-container">
    <div id="search"></div>
  </div>

  <div class="filters" role="group" aria-label="Filter posts by type">
    <button class="filter-btn active" data-filter="all" aria-pressed="true">All</button>
    <button class="filter-btn" data-filter="essay" aria-pressed="false">Essays</button>
    <button class="filter-btn" data-filter="poem" aria-pressed="false">Poems</button>
    <button class="filter-btn" data-filter="newsletter" aria-pressed="false">Newsletter</button>
    <button class="filter-btn" data-filter="research" aria-pressed="false">Research</button>
  </div>

  <div class="posts">
    {sortedPosts.map((post) => {
      const postType = getPostType(post);
      return (
        <a href={`/writing/${post.slug}/`} class:list={['post-entry', { 'post-entry--poem': postType === 'poem' }]} data-type={postType}>
          <div class="post-entry__bar"></div>
          <div class="post-entry__header">
            <h3 class="post-entry__title">{post.data.title}</h3>
            <span class:list={['tag', `tag--${postType}`]}>
              {postType}
            </span>
          </div>
          {post.data.excerpt && (
            <p class="post-entry__excerpt">{post.data.excerpt}</p>
          )}
          <p class="post-entry__date">
            {formatDate(post.data.date)}
          </p>
        </a>
      );
    })}
  </div>

  <link href="/pagefind/pagefind-ui.css" rel="stylesheet" />
  <script src="/pagefind/pagefind-ui.js" is:inline></script>
  <script is:inline>
    window.addEventListener('DOMContentLoaded', () => {
      new PagefindUI({
        element: '#search',
        showSubResults: false,
        showImages: false,
      });
    });
  </script>

  <script>
    const filterBtns = document.querySelectorAll('.filter-btn');
    const posts = document.querySelectorAll('.post-entry');

    filterBtns.forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.getAttribute('data-filter');

        // Update active button and aria-pressed state
        filterBtns.forEach(b => {
          b.classList.remove('active');
          b.setAttribute('aria-pressed', 'false');
        });
        btn.classList.add('active');
        btn.setAttribute('aria-pressed', 'true');

        // Filter posts
        posts.forEach(post => {
          const type = post.getAttribute('data-type');
          if (filter === 'all' || type === filter) {
            post.style.display = '';
          } else {
            post.style.display = 'none';
          }
        });
      });
    });
  </script>

  <style>
    .filters {
      display: flex;
      gap: 8px;
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
    }

    .filter-btn {
      font-family: var(--font-sans);
      font-size: 12px;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: 3px;
      background: transparent;
      color: var(--color-text-muted);
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .filter-btn:hover {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .filter-btn.active {
      background: var(--color-accent);
      border-color: var(--color-accent);
      color: var(--color-bg);
    }

    .filter-btn:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .search-container {
      margin-bottom: var(--space-3);
    }

    /* Pagefind UI customization */
    :root {
      --pagefind-ui-scale: 0.9;
      --pagefind-ui-primary: var(--color-accent);
      --pagefind-ui-text: var(--color-text);
      --pagefind-ui-background: var(--color-bg);
      --pagefind-ui-border: var(--color-border);
      --pagefind-ui-tag: var(--color-bg-subtle);
      --pagefind-ui-border-width: 1px;
      --pagefind-ui-border-radius: 3px;
      --pagefind-ui-font: var(--font-sans);
    }

    .pagefind-ui__search-input {
      font-family: var(--font-sans) !important;
    }

    .pagefind-ui__result-link {
      color: var(--color-text) !important;
    }

    .pagefind-ui__result-link:hover {
      color: var(--color-accent) !important;
    }
  </style>
</BaseLayout>
